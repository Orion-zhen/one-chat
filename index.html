<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>One Chat</title>
    <style>
        /* CSS Variables */
        :root {
            --accent-color: #007AFF;
            --background-color: #161617;
            --text-color-primary: #f5f5f7;
            --text-color-secondary: #a1a1a6;
            --container-bg-color: rgba(44, 44, 46, 0.6);
            --border-color: rgba(255, 255, 255, 0.15);
            --shadow-color: rgba(0, 0, 0, 0.2);
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --border-radius-large: 24px;
            --border-radius-medium: 16px;
            --border-radius-small: 12px;
            --border-radius-tiny: 8px;
            --line-height: 1.7;
            --transition-duration: 0.3s;
            --blur-intensity: 30px;

            /* Token Probability Colormap (Low to High) */
            --prob-color-low: rgba(255, 128, 128, 0.2);
            /* Muted Red */
            --prob-color-mid: rgba(255, 255, 128, 0.25);
            /* Muted Yellow */
            --prob-color-high: rgba(128, 255, 128, 0.35);
            /* Muted Green */
        }

        /* Basic Resets & Global Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html,
        body {
            height: 100%;
            overflow: hidden;
        }

        body {
            background-color: var(--background-color);
            color: var(--text-color-primary);
            font-family: var(--font-family);
            line-height: var(--line-height);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        /* Aurora Background */
        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                radial-gradient(circle at 10% 20%, hsla(210, 80%, 50%, 0.2) 0px, transparent 40%),
                radial-gradient(circle at 90% 80%, hsla(280, 80%, 50%, 0.2) 0px, transparent 40%),
                radial-gradient(circle at 50% 50%, hsla(180, 80%, 50%, 0.15) 0px, transparent 35%);
            animation: aurora-flow 25s infinite ease-in-out;
            z-index: -1;
        }

        @keyframes aurora-flow {
            0% {
                transform: rotate(0deg) scale(1.5);
                opacity: 0.8;
            }

            50% {
                transform: rotate(180deg) scale(2.0);
                opacity: 1;
            }

            100% {
                transform: rotate(360deg) scale(1.5);
                opacity: 0.8;
            }
        }

        /* Main Layout */
        .chat-wrapper {
            width: 100%;
            height: 100%;
            max-width: 860px;
            display: flex;
            flex-direction: column;
            padding: 16px 16px 24px 16px;
        }

        #chat-container {
            flex-grow: 1;
            overflow-y: auto;
            padding: 0 16px;
            display: flex;
            flex-direction: column;
            gap: 48px;
        }

        /* Custom Scrollbar */
        #chat-container::-webkit-scrollbar {
            width: 6px;
        }

        #chat-container::-webkit-scrollbar-thumb {
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
        }

        #chat-container::-webkit-scrollbar-track {
            background: transparent;
        }

        /* Message Bubbles */
        .message {
            max-width: 90%;
            display: flex;
            flex-direction: column;
            opacity: 0;
            transform: translateY(20px);
            animation: fade-in-up 0.5s ease-in-out forwards;
        }

        .message-content {
            padding: 16px 24px;
            background-color: var(--container-bg-color);
            backdrop-filter: blur(var(--blur-intensity));
            -webkit-backdrop-filter: blur(var(--blur-intensity));
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-large);
            box-shadow: 0 8px 32px var(--shadow-color);
            word-wrap: break-word;
            white-space: pre-wrap;
        }

        .message-content p:not(:last-child) {
            margin-bottom: 1em;
        }

        .message-content pre {
            background-color: rgba(0, 0, 0, 0.3);
            padding: 16px;
            border-radius: var(--border-radius-small);
            overflow-x: auto;
            font-family: "SF Mono", "Fira Code", monospace;
            font-size: 0.9em;
            white-space: pre;
        }

        .message-content code {
            font-family: "SF Mono", "Fira Code", monospace;
            background-color: rgba(0, 0, 0, 0.2);
            padding: 2px 4px;
            border-radius: var(--border-radius-tiny);
        }

        .user-message {
            align-self: flex-end;
            align-items: flex-end;
        }

        .user-message .message-content {
            background-color: rgba(0, 122, 255, 0.4);
        }

        .ai-message {
            align-self: flex-start;
            align-items: flex-start;
        }

        .message-footer {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-top: 12px;
            font-size: 0.8em;
            color: var(--text-color-secondary);
        }

        .message-stats {
            font-size: 13px;
            user-select: none;
        }

        .action-button {
            background: none;
            border: none;
            color: var(--text-color-secondary);
            cursor: pointer;
            padding: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color var(--transition-duration) ease-in-out;
            opacity: 0.7;
        }

        .action-button:hover {
            color: var(--text-color-primary);
            opacity: 1;
        }

        .action-button:active {
            transform: scale(0.95);
        }

        .action-button svg {
            width: 16px;
            height: 16px;
        }

        .prob-notice {
            font-size: 13px;
            margin-bottom: 8px;
            padding: 6px 12px;
            /* Adjusted padding for better look with large radius */
            background-color: rgba(255, 255, 0, 0.1);
            border: 1px solid rgba(255, 255, 0, 0.2);
            color: rgba(255, 255, 0, 0.8);
            display: inline-block;
            /* To make it fit the content */
            border-radius: var(--border-radius-large);
            /* FIXED: Use the same large radius */
        }

        @keyframes fade-in-up {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Chat Input Area */
        .chat-input-area {
            position: relative;
            margin-top: 16px;
            padding: 0 16px;
            width: 100%;
        }

        #chat-form {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 12px;
            background-color: var(--container-bg-color);
            backdrop-filter: blur(var(--blur-intensity));
            -webkit-backdrop-filter: blur(var(--blur-intensity));
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-large);
            box-shadow: 0 8px 32px var(--shadow-color);
        }

        #prompt-input {
            flex-grow: 1;
            background: none;
            border: none;
            outline: none;
            color: var(--text-color-primary);
            font-family: var(--font-family);
            font-size: 16px;
            resize: none;
            line-height: 1.6;
            max-height: 200px;
            scrollbar-width: none;
        }

        #prompt-input::-webkit-scrollbar {
            display: none;
        }

        #prompt-input:focus {
            outline: none;
        }

        .input-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        #submit-button,
        #settings-button {
            width: 44px;
            height: 44px;
            border-radius: 999px;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: transform var(--transition-duration) ease-in-out, background-color var(--transition-duration) ease-in-out;
        }

        #settings-button {
            background-color: rgba(255, 255, 255, 0.1);
        }

        #submit-button {
            background-color: var(--accent-color);
            color: white;
        }

        #submit-button:disabled {
            background-color: #555;
            cursor: not-allowed;
            transform: scale(1);
        }

        #submit-button:not(:disabled):active,
        #settings-button:active {
            transform: scale(0.92);
        }

        #submit-button svg {
            width: 24px;
            height: 24px;
            transition: transform 0.3s ease-in-out;
        }

        #submit-button.generating #send-icon {
            transform: rotate(90deg) scale(0);
        }

        #submit-button.generating #stop-icon {
            transform: rotate(0) scale(1);
        }

        #submit-button:not(.generating) #send-icon {
            transform: rotate(0) scale(1);
        }

        #submit-button:not(.generating) #stop-icon {
            transform: rotate(-90deg) scale(0);
        }

        #stop-icon {
            position: absolute;
        }

        /* Token Probability Visualization */
        .token {
            display: inline;
            transition: background-color 0.2s ease-in-out;
            border-radius: 4px;
            cursor: default;
            background-color: color-mix(in srgb, var(--prob-color-low), var(--prob-color-high) calc(100% * var(--prob-value, 0)));
        }

        #token-popover {
            position: fixed;
            z-index: 1000;
            padding: 12px;
            background-color: rgba(30, 30, 32, 0.8);
            backdrop-filter: blur(var(--blur-intensity));
            -webkit-backdrop-filter: blur(var(--blur-intensity));
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: var(--border-radius-medium);
            box-shadow: 0 8px 32px var(--shadow-color);
            opacity: 0;
            pointer-events: none;
            transform: translateY(10px);
            transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out;
            width: 250px;
        }

        #token-popover.visible {
            opacity: 1;
            pointer-events: auto;
            transform: translateY(0);
        }

        .popover-title {
            font-weight: 600;
            margin-bottom: 12px;
            font-size: 14px;
        }

        .popover-title span {
            background-color: rgba(255, 255, 255, 0.1);
            padding: 2px 6px;
            border-radius: var(--border-radius-tiny);
        }

        .popover-list {
            list-style: none;
            display: flex;
            flex-direction: column;
            gap: 4px;
            font-size: 13px;
            font-family: "SF Mono", "Fira Code", monospace;
        }

        .popover-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
        }

        .popover-token {
            background-color: rgba(0, 0, 0, 0.2);
            padding: 1px 5px;
            border-radius: 4px;
            white-space: pre;
        }

        .popover-prob {
            color: var(--text-color-secondary);
        }

        /* Settings Modal */
        #settings-modal {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity var(--transition-duration) ease-in-out;
            z-index: 2000;
        }

        #settings-modal.visible {
            opacity: 1;
            pointer-events: auto;
        }

        .settings-content {
            width: 90%;
            max-width: 500px;
            padding: 32px;
            background-color: var(--container-bg-color);
            backdrop-filter: blur(var(--blur-intensity));
            -webkit-backdrop-filter: blur(var(--blur-intensity));
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-large);
            box-shadow: 0 8px 32px var(--shadow-color);
            transform: scale(0.95);
            transition: transform var(--transition-duration) ease-in-out;
            max-height: 90vh;
            overflow-y: auto;
        }

        #settings-modal.visible .settings-content {
            transform: scale(1);
        }

        .settings-header {
            font-size: 1.5em;
            font-weight: 600;
            margin-bottom: 24px;
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-color-secondary);
            font-size: 0.9em;
        }

        .form-group .label-with-value {
            display: flex;
            justify-content: space-between;
        }

        .form-input {
            width: 100%;
            background-color: rgba(0, 0, 0, 0.2);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-small);
            padding: 12px;
            color: var(--text-color-primary);
            font-size: 1em;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        #system-prompt {
            resize: vertical;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.3);
        }

        .form-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.2);
            outline: none;
            border-radius: 999px;
        }

        .form-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: var(--text-color-primary);
            cursor: pointer;
            border-radius: 50%;
            border: 3px solid var(--background-color);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .chat-wrapper {
                padding: 8px 0 16px 0;
            }

            #chat-container {
                gap: 32px;
            }

            .message-content {
                padding: 12px 16px;
            }

            #chat-form {
                border-radius: var(--border-radius-medium);
            }
        }
    </style>
</head>

<body>
    <div class="chat-wrapper">
        <div id="chat-container"></div>
        <div class="chat-input-area">
            <form id="chat-form">
                <textarea id="prompt-input" placeholder="Chat with model..." rows="1"></textarea>
                <div class="input-actions">
                    <button type="button" id="settings-button" title="Settings"><svg xmlns="http://www.w3.org/2000/svg"
                            width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path
                                d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2.4l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l-.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0-2.4l.15-.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" />
                            <circle cx="12" cy="12" r="3" />
                        </svg></button>
                    <button type="submit" id="submit-button" title="Send"><svg id="send-icon"
                            xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="22" y1="2" x2="11" y2="13" />
                            <polygon points="22 2 15 22 11 13 2 9 22 2" />
                        </svg><svg id="stop-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                            viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2"
                            stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
                        </svg></button>
                </div>
            </form>
        </div>
    </div>
    <div id="token-popover">
        <div class="popover-title">Top 10 Tokens for "<span>...</span>"</div>
        <ul class="popover-list"></ul>
    </div>
    <div id="settings-modal">
        <div class="settings-content">
            <div class="settings-header">API & Model Settings</div>
            <div class="form-group"><label for="api-endpoint">API Endpoint (OpenAI Compatible)</label><input type="text"
                    id="api-endpoint" class="form-input" placeholder="e.g., https://api.openai.com/v1/chat/completions">
            </div>
            <div class="form-group"><label for="api-key">API Key</label><input type="password" id="api-key"
                    class="form-input" placeholder="Enter your API key"></div>
            <div class="form-group"><label for="model-name">Model Name</label><input type="text" id="model-name"
                    class="form-input" placeholder="e.g., gpt-4-turbo"></div>
            <div class="form-group"><label for="system-prompt">System Prompt (Optional)</label><textarea
                    id="system-prompt" class="form-input" rows="3"
                    placeholder="e.g., You are a helpful assistant that always replies in Markdown."></textarea></div>
            <div class="form-group"><label for="temperature" class="label-with-value"><span>Temperature</span><span
                        id="temperature-value">1.0</span></label><input type="range" id="temperature"
                    class="form-slider" min="0" max="2" step="0.1" value="1.0"></div>
            <div class="form-group"><label for="top-p" class="label-with-value"><span>Top P</span><span
                        id="top-p-value">1.0</span></label><input type="range" id="top-p" class="form-slider" min="0"
                    max="1" step="0.05" value="1.0"></div>
            <div class="form-group"><label for="top-k" class="label-with-value"><span>Top K</span><span
                        id="top-k-value">50</span></label><input type="range" id="top-k" class="form-slider" min="1"
                    max="100" step="1" value="50"></div>
            <div class="form-group"><label for="max-new-tokens" class="label-with-value"><span>Max New
                        Tokens</span><span id="max-new-tokens-value">2048</span></label><input type="range"
                    id="max-new-tokens" class="form-slider" min="256" max="8192" step="256" value="2048"></div>
            <div style="font-size: 0.8em; color: var(--text-color-secondary);">Settings are saved locally in your
                browser.</div>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // DOM Elements
            const chatContainer = document.getElementById('chat-container'), chatForm = document.getElementById('chat-form'),
                promptInput = document.getElementById('prompt-input'), submitButton = document.getElementById('submit-button'),
                settingsButton = document.getElementById('settings-button'), settingsModal = document.getElementById('settings-modal'),
                tokenPopover = document.getElementById('token-popover');

            // Settings Elements
            const apiEndpointInput = document.getElementById('api-endpoint'), apiKeyInput = document.getElementById('api-key'),
                modelNameInput = document.getElementById('model-name'), systemPromptInput = document.getElementById('system-prompt'),
                temperatureInput = document.getElementById('temperature'), topPInput = document.getElementById('top-p'),
                topKInput = document.getElementById('top-k'), maxNewTokensInput = document.getElementById('max-new-tokens'),
                temperatureValue = document.getElementById('temperature-value'), topPValue = document.getElementById('top-p-value'),
                topKValue = document.getElementById('top-k-value'), maxNewTokensValue = document.getElementById('max-new-tokens-value');

            // State
            let conversationHistory = [], isGenerating = false, abortController = null;

            // --- Settings Logic ---
            const settings = {
                'api-endpoint': apiEndpointInput, 'api-key': apiKeyInput, 'model-name': modelNameInput,
                'system-prompt': systemPromptInput, 'temperature': temperatureInput, 'top-p': topPInput,
                'top-k': topKInput, 'max-new-tokens': maxNewTokensInput,
            };

            function updateSliderValue(input, display) { display.textContent = input.value; }
            function saveSettings() { for (const key in settings) { localStorage.setItem(key, settings[key].value); } }
            function loadSettings() {
                for (const key in settings) {
                    const value = localStorage.getItem(key);
                    if (value !== null) { settings[key].value = value; }
                }
                updateSliderValue(temperatureInput, temperatureValue);
                updateSliderValue(topPInput, topPValue);
                updateSliderValue(topKInput, topKValue);
                updateSliderValue(maxNewTokensInput, maxNewTokensValue);
            }

            [temperatureInput, topPInput, topKInput, maxNewTokensInput].forEach(input => {
                const display = document.getElementById(`${input.id}-value`);
                input.addEventListener('input', () => updateSliderValue(input, display));
            });

            settingsButton.addEventListener('click', () => settingsModal.classList.add('visible'));
            settingsModal.addEventListener('click', (e) => {
                if (e.target === settingsModal) { saveSettings(); settingsModal.classList.remove('visible'); }
            });

            // --- Auto-resize Textarea ---
            promptInput.addEventListener('input', () => {
                promptInput.style.height = 'auto'; promptInput.style.height = `${promptInput.scrollHeight}px`;
            });

            // --- Popover Logic ---
            let popoverHideTimeout;
            function showTokenPopover(target, topLogprobs) {
                clearTimeout(popoverHideTimeout);
                const rect = target.getBoundingClientRect();
                tokenPopover.querySelector('.popover-title span').textContent = target.textContent;
                const list = tokenPopover.querySelector('.popover-list');
                list.innerHTML = '';
                topLogprobs.forEach(item => {
                    const probPercent = (Math.exp(item.logprob) * 100).toFixed(2);
                    const li = document.createElement('li');
                    li.innerHTML = `<span class="popover-token">${item.token.replace(/\s/g, (m) => ({ ' ': '&nbsp;', '\n': '\\n', '\t': '\\t' })[m] || m)}</span><span class="popover-prob">${probPercent}%</span>`;
                    list.appendChild(li);
                });
                tokenPopover.style.left = `${rect.left + rect.width / 2 - tokenPopover.offsetWidth / 2}px`;
                tokenPopover.style.top = `${rect.top - tokenPopover.offsetHeight - 8}px`;
                if (parseInt(tokenPopover.style.top) < 0) { tokenPopover.style.top = `${rect.bottom + 8}px`; }
                tokenPopover.classList.add('visible');
            }
            function hideTokenPopover() { popoverHideTimeout = setTimeout(() => tokenPopover.classList.remove('visible'), 200); }
            tokenPopover.addEventListener('mouseenter', () => clearTimeout(popoverHideTimeout));
            tokenPopover.addEventListener('mouseleave', () => hideTokenPopover());

            // --- UI Rendering ---
            function renderMessage(role, content) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${role}-message`;
                const contentDiv = document.createElement('div');
                contentDiv.className = 'message-content';
                if (role === 'user') { contentDiv.textContent = content; }
                messageDiv.appendChild(contentDiv);
                chatContainer.appendChild(messageDiv);
                scrollToBottom();
                return { messageDiv, contentDiv };
            }
            function scrollToBottom() { chatContainer.scrollTop = chatContainer.scrollHeight; }

            // --- Form Submission Handler ---
            chatForm.addEventListener('submit', (e) => {
                e.preventDefault();
                if (isGenerating) { if (abortController) abortController.abort(); return; }
                const prompt = promptInput.value.trim();
                if (!prompt) return;
                conversationHistory.push({ role: 'user', content: prompt });
                renderMessage('user', prompt);
                promptInput.value = ''; promptInput.style.height = 'auto';
                executeGeneration(conversationHistory);
            });

            // --- Core Generation Logic ---
            async function executeGeneration(history) {
                isGenerating = true; promptInput.disabled = true; submitButton.classList.add('generating');
                abortController = new AbortController();

                const { messageDiv: aiMessageDiv, contentDiv: aiContentDiv } = renderMessage('ai');
                const startTime = performance.now();
                let tokenCount = 0, finalUsage = null, logprobsAvailable = true;

                const messagesForRequest = [...history];
                const systemPrompt = systemPromptInput.value.trim();
                if (systemPrompt) { messagesForRequest.unshift({ role: 'system', content: systemPrompt }); }

                try {
                    const response = await fetch(apiEndpointInput.value, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKeyInput.value}` },
                        body: JSON.stringify({
                            model: modelNameInput.value, messages: messagesForRequest,
                            temperature: parseFloat(temperatureInput.value), top_p: parseFloat(topPInput.value),
                            top_k: parseInt(topKInput.value), max_tokens: parseInt(maxNewTokensInput.value),
                            stream: true, stream_options: { include_usage: true }, logprobs: true, top_logprobs: 10
                        }),
                        signal: abortController.signal
                    });

                    if (!response.ok) { throw new Error((await response.json()).error.message); }

                    const reader = response.body.getReader(), decoder = new TextDecoder();
                    let buffer = '';
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        buffer += decoder.decode(value, { stream: true });
                        const lines = buffer.split('\n');
                        buffer = lines.pop();
                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                const data = line.substring(6);
                                if (data.trim() === '[DONE]') break;
                                const chunk = JSON.parse(data);
                                if (chunk.usage) { finalUsage = chunk.usage; }
                                const choice = chunk.choices && chunk.choices[0];
                                if (!choice) continue;

                                if (tokenCount === 0 && !choice.logprobs) {
                                    logprobsAvailable = false;
                                    const notice = document.createElement('div');
                                    notice.className = 'prob-notice';
                                    notice.textContent = 'Token probabilities not available.';
                                    aiMessageDiv.insertBefore(notice, aiContentDiv);
                                }
                                const delta = choice.delta?.content;
                                if (delta) {
                                    tokenCount++;
                                    if (logprobsAvailable && choice.logprobs) {
                                        const logprobInfo = choice.logprobs.content[0];
                                        const tokenSpan = document.createElement('span');
                                        tokenSpan.className = 'token'; tokenSpan.textContent = delta;
                                        tokenSpan.style.setProperty('--prob-value', Math.exp(logprobInfo.logprob));
                                        tokenSpan.addEventListener('mouseenter', (e) => showTokenPopover(e.target, logprobInfo.top_logprobs));
                                        tokenSpan.addEventListener('mouseleave', hideTokenPopover);
                                        aiContentDiv.appendChild(tokenSpan);
                                    } else {
                                        aiContentDiv.textContent += delta;
                                    }
                                    scrollToBottom();
                                }
                            }
                        }
                    }
                    conversationHistory.push({ role: 'assistant', content: aiContentDiv.textContent });
                } catch (error) {
                    const message = error.name === 'AbortError' ? '\n\n[Output interrupted by user]' : `\n\n[Error: ${error.message}]`;
                    aiContentDiv.textContent += message;
                    if (error.name !== 'AbortError') {
                        conversationHistory.push({ role: 'assistant', content: aiContentDiv.textContent });
                    }
                } finally {
                    const duration = ((performance.now() - startTime) / 1000).toFixed(2);
                    const tokensUsed = finalUsage?.completion_tokens ?? tokenCount;
                    const tokensPerSecond = (tokensUsed / duration).toFixed(2);

                    const footer = document.createElement('div');
                    footer.className = 'message-footer';
                    footer.innerHTML = `<div class="message-stats">Time: ${duration}s | Tokens: ${tokensUsed} | Speed: ${tokensPerSecond} tok/s</div>`;
                    const regenButton = document.createElement('button');
                    regenButton.className = 'action-button';
                    regenButton.title = 'Regenerate';
                    regenButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M3 21v-5h5"/></svg>`;
                    regenButton.onclick = () => regenerateLastMessage(aiMessageDiv);
                    footer.appendChild(regenButton);
                    aiMessageDiv.appendChild(footer);

                    isGenerating = false; promptInput.disabled = false; submitButton.classList.remove('generating');
                    abortController = null; promptInput.focus(); scrollToBottom();
                }
            }

            function regenerateLastMessage(messageToRemove) {
                if (isGenerating) return;
                messageToRemove.remove();
                if (conversationHistory.length > 0 && conversationHistory.at(-1).role === 'assistant') {
                    conversationHistory.pop();
                }
                if (conversationHistory.length > 0) { executeGeneration(conversationHistory); }
            }
            loadSettings();
        });
    </script>
</body>

</html>